/**
 * 8ï¸âƒ£ Crear grÃ¡ficos (4 grÃ¡ficos asegurados)
 */
function crearGraficos(hoja, encabezados, nuevosDatos) {
    if (nuevosDatos.length === 0) {
        Logger.log("No hay datos disponibles para graficar.");
        return;
    }

    var posicionFila = hoja.getLastRow() + 5; // ðŸ“Œ Ubicar los grÃ¡ficos despuÃ©s de la Ãºltima fila ocupada

    // ðŸ“Š 1ï¸âƒ£ GrÃ¡fico: GPU Utilization y Normalized GPU Time
    let columnasGrafico1_Y = ["gpu_utilization_percentage", "normalized_gpu_time", "seÃ±al_activa"];
    crearGraficoMultiple(hoja, "Time Stamp", columnasGrafico1_Y, "GPU Utilization & Normalized Render Time", "Time (ms)", "Valores", posicionFila);
    posicionFila += 20;

    // ðŸ“Š 2ï¸âƒ£ GrÃ¡fico: FPS y Stale Frames
    let columnasGrafico2_Y = ["average_frame_rate", "stale_frame_count", "seÃ±al_activa"];
    crearGraficoMultiple(hoja, "Time Stamp", columnasGrafico2_Y, "FPS & Stale Frames Over Time", "Time (ms)", "FPS & Stale Frames", posicionFila);
    posicionFila += 20;

    // ðŸ“Š 3ï¸âƒ£ GrÃ¡fico: CPU vs GPU Utilization
    let columnasGrafico3_Y = ["cpu_utilization_percentage", "gpu_utilization_percentage", "seÃ±al_activa"];
    crearGraficoMultiple(hoja, "Time Stamp", columnasGrafico3_Y, "CPU vs GPU Utilization", "Time (ms)", "Utilization (%)", posicionFila);
    posicionFila += 20;

    // ðŸ“Š 4ï¸âƒ£ GrÃ¡fico: Early Frames vs Stale Frames Consecutive
    let columnasGrafico4_Y = ["early_frame_count", "stale_frames_consecutive", "seÃ±al_activa"];
    crearGraficoMultiple(hoja, "Time Stamp", columnasGrafico4_Y, "Early Frames vs Stale Frames Consecutive", "Time (ms)", "Frames Count", posicionFila);
}

/**
 * ðŸ“Š FunciÃ³n para grÃ¡ficos mÃºltiples (corrige la leyenda con nombres correctos)
 */
function crearGraficoMultiple(hoja, colX, colYs, titulo, ejeX, ejeY, filaGrafico) {
    var datos = hoja.getDataRange().getValues();
    var encabezados = datos[0]; // âœ… Obtener encabezados correctamente

    var indexX = encabezados.indexOf(colX) + 1;
    var indicesY = colYs.map(colY => encabezados.indexOf(colY) + 1);

    if (indexX === 0 || indicesY.includes(0)) {
        Logger.log("âš  No se encontraron columnas necesarias para el grÃ¡fico: " + titulo);
        return;
    }

    // âœ… Seleccionar rango de datos incluyendo la fila de encabezado
    var rangoTiempo = hoja.getRange(1, indexX, hoja.getLastRow()); // ðŸ“Œ Desde la fila 1 para la leyenda
    var rangosY = indicesY.map(indexY => hoja.getRange(1, indexY, hoja.getLastRow()));

    var chartBuilder = hoja.newChart()
        .setChartType(Charts.ChartType.LINE)
        .addRange(rangoTiempo);

    // âœ… Agregar las series con etiquetas correctas en la leyenda
    rangosY.forEach((rangoY, index) => {
        chartBuilder.addRange(rangoY);
        chartBuilder.setOption(`series.${index}.labelInLegend`, encabezados[indicesY[index] - 1]); // Asigna nombres correctos
    });

    chartBuilder
        .setPosition(filaGrafico, 1, 0, 0)
        .setOption('title', titulo)
        .setOption('hAxis', { title: ejeX })
        .setOption('vAxis', { title: ejeY })
        .setOption('legend', { position: 'right' }) // âœ… Asegurar que la leyenda se muestre
        .setOption('useFirstRowAsHeaders', true)  // âœ… Incluir la primera fila como encabezado en la leyenda
        .setOption('series', {
            0: { color: "red" },
            1: { color: "blue" },
            2: { color: "yellow" } // âœ… Definir colores para que sean mÃ¡s fÃ¡ciles de leer
        });

    var chart = chartBuilder.build();
    hoja.insertChart(chart);
}
